<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>시:그널 - 상세 보기</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>

<body>

<div th:replace="layout/header :: header"></div>

<main class="container container-detail">
    <div class="form-box">

        <div class="detail-head">
            <div class="meta-line">
                <span class="badge badge-cat" th:text="${complaint.category}">카테고리</span>
                <span class="badge status"
                      th:classappend="${complaint.status == '접수'} ? ' status-received' : (${complaint.status == '처리중'} ? ' status-progress' : ' status-done')"
                      th:text="${complaint.status}">상태</span>
            </div>

            <h1 class="page-title" th:text="${complaint.title}">민원 제목</h1>

            <div class="detail-meta">
                <span>📅 <span th:text="${#temporals.format(complaint.createdAt, 'yyyy-MM-dd HH:mm')}"></span></span>
                <span>📍 <span th:text="${complaint.location}">위치 정보</span></span>
            </div>
        </div>

        <div class="detail-image" th:if="${complaint.imagePath != null}">
            <img th:src="@{'/uploads/' + ${complaint.imagePath}}" alt="현장 사진">
        </div>

        <div class="detail-content" th:text="${complaint.content}">내용</div>

        <div class="like-section">
            <form th:action="@{|/complaints/like/${complaint.id}|}" method="post">
                <button type="submit" class="like-btn">♥ 공감해요 <span th:text="${complaint.likes}">0</span></button>
            </form>
        </div>

        <div class="answer-box">
            <h3 class="answer-title">📢 담당자 답변</h3>

            <div th:if="${complaint.answer != null}">
                <div class="detail-content" th:text="${complaint.answer}"></div>
                <div class="answer-dept">담당부서: 도로교통과</div>
            </div>

            <div th:unless="${complaint.answer != null}" class="answer-empty">
                현재 담당 부서에서 내용을 확인하고 있습니다.
            </div>
        </div>

        <div class="comment-section">
            <h3>💬 댓글 <span class="comment-count" th:text="${comments != null ? #lists.size(comments) : 0}">0</span></h3>

            <form th:action="@{/comments/add}" method="post" class="comment-form">
                <input type="hidden" name="complaintId" th:value="${complaint.id}" />

                <div class="comment-row">
                    <input type="text" name="author" placeholder="작성자" class="form-control" required>
                    <input type="password" name="password" placeholder="비밀번호" class="form-control" required>
                </div>

                <div class="comment-editor">
                    <textarea name="content" placeholder="댓글을 남겨주세요" class="form-control" required></textarea>
                    <button type="submit" class="btn btn-blue">등록</button>
                </div>
            </form>

            <ul class="comment-list">
                <li th:if="${comments == null or #lists.isEmpty(comments)}" class="comment-empty">
                    첫 번째 댓글을 남겨보세요!
                </li>

                <li th:if="${comments != null}" th:each="reply : ${comments}" class="comment-item">
                    <div class="comment-item-top">
                        <span class="comment-author" th:text="${reply.author}">작성자</span>
                        <span class="comment-date" th:text="${#temporals.format(reply.createdAt, 'MM-dd HH:mm')}">날짜</span>
                    </div>
                    <div class="comment-body" th:text="${reply.content}">내용</div>
                </li>
            </ul>
        </div>

        <div class="detail-actions">
            <div th:if="${(complaint.author != null and #authentication.name == complaint.author.username) or #authorization.expression('hasRole(''ADMIN'')')}">
                <form th:action="@{|/complaints/delete/${complaint.id}|}" method="post"
                      onsubmit="return confirm('정말 삭제하시겠습니까? 복구할 수 없습니다.');">
                    <button type="submit" class="btn btn-danger">🗑️ 삭제하기</button>
                </form>
            </div>

            <a th:href="@{'/complaints/list'}" class="btn btn-ghost">목록으로</a>
        </div>

    </div>
</main>

</body>
</html>
